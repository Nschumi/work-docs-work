#!/bin/bash
# GitHub Project Board Advanced Configuration via CLI
# Sets up professional project tracking with columns, fields, and views

set -e

echo "üéØ GitHub Project Board Advanced Configuration"
echo "============================================="

# Configuration
ORG="Nuuday"
REPO_NAME="saga-ecommerce-service" 
PROJECT_TITLE="SAGA eCommerce Development"

# Check if gh is installed and authenticated
if ! command -v gh &> /dev/null; then
    echo "‚ùå GitHub CLI (gh) is not installed"
    exit 1
fi

if ! gh auth status &> /dev/null; then
    echo "‚ùå Not authenticated with GitHub"
    exit 1
fi

echo "üìã Configuration:"
echo "  Organization: $ORG"
echo "  Repository: $REPO_NAME"
echo "  Project: $PROJECT_TITLE"
echo ""

# Check if project exists, if not create it
echo "1Ô∏è‚É£ Checking/Creating project..."

PROJECT_ID=$(gh project list --owner "$ORG" --format json | jq -r ".[] | select(.title==\"$PROJECT_TITLE\") | .id" 2>/dev/null || echo "")

if [ -z "$PROJECT_ID" ]; then
    echo "Creating new project..."
    PROJECT_RESPONSE=$(gh project create --owner "$ORG" --title "$PROJECT_TITLE" --format json)
    PROJECT_ID=$(echo "$PROJECT_RESPONSE" | jq -r '.id')
    echo "‚úÖ Project created with ID: $PROJECT_ID"
else
    echo "‚úÖ Project found with ID: $PROJECT_ID"
fi

# Link repository to project
echo ""
echo "2Ô∏è‚É£ Linking repository to project..."
gh project link "$PROJECT_ID" --repo "$ORG/$REPO_NAME" 2>/dev/null || echo "‚ö†Ô∏è  Repository may already be linked"

# Get current field IDs for cleanup/reference
echo ""
echo "3Ô∏è‚É£ Getting current project structure..."

# Create custom fields
echo ""
echo "4Ô∏è‚É£ Creating custom fields..."

# Story Points field
echo "Creating Story Points field..."
STORY_POINTS_FIELD=$(gh project field-create "$PROJECT_ID" \
    --name "Story Points" \
    --data-type "number" \
    --format json | jq -r '.id' 2>/dev/null || echo "")

if [ ! -z "$STORY_POINTS_FIELD" ]; then
    echo "‚úÖ Story Points field created: $STORY_POINTS_FIELD"
else
    echo "‚ö†Ô∏è  Story Points field may already exist"
fi

# Sprint field (single select)
echo "Creating Sprint field..."
SPRINT_FIELD=$(gh project field-create "$PROJECT_ID" \
    --name "Sprint" \
    --data-type "single_select" \
    --format json | jq -r '.id' 2>/dev/null || echo "")

if [ ! -z "$SPRINT_FIELD" ]; then
    echo "‚úÖ Sprint field created: $SPRINT_FIELD"
    
    # Add sprint options
    echo "Adding sprint options..."
    gh project field-create "$PROJECT_ID" --field-id "$SPRINT_FIELD" --single-select-option "Sprint 0 - Foundation" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$SPRINT_FIELD" --single-select-option "Sprint 1 - Multi-tenant" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$SPRINT_FIELD" --single-select-option "Sprint 2 - Multi-tenant" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$SPRINT_FIELD" --single-select-option "Sprint 3 - Catalog" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$SPRINT_FIELD" --single-select-option "Sprint 4 - Catalog" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$SPRINT_FIELD" --single-select-option "Sprint 5 - Channel" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$SPRINT_FIELD" --single-select-option "Sprint 6 - Channel" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$SPRINT_FIELD" --single-select-option "Sprint 7 - Open Pages MVP" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$SPRINT_FIELD" --single-select-option "Sprint 8 - Production Prep" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$SPRINT_FIELD" --single-select-option "Sprint 9 - Production Prep" 2>/dev/null || true
    echo "‚úÖ Sprint options added"
else
    echo "‚ö†Ô∏è  Sprint field may already exist"
fi

# Module field (single select)
echo "Creating Module field..."
MODULE_FIELD=$(gh project field-create "$PROJECT_ID" \
    --name "Module" \
    --data-type "single_select" \
    --format json | jq -r '.id' 2>/dev/null || echo "")

if [ ! -z "$MODULE_FIELD" ]; then
    echo "‚úÖ Module field created: $MODULE_FIELD"
    
    # Add module options
    echo "Adding module options..."
    gh project field-create "$PROJECT_ID" --field-id "$MODULE_FIELD" --single-select-option "Infrastructure" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$MODULE_FIELD" --single-select-option "Catalog" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$MODULE_FIELD" --single-select-option "Channel" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$MODULE_FIELD" --single-select-option "Basket" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$MODULE_FIELD" --single-select-option "Order" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$MODULE_FIELD" --single-select-option "Payment" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$MODULE_FIELD" --single-select-option "Tenant Management" 2>/dev/null || true
    gh project field-create "$PROJECT_ID" --field-id "$MODULE_FIELD" --single-select-option "Authentication" 2>/dev/null || true
    echo "‚úÖ Module options added"
else
    echo "‚ö†Ô∏è  Module field may already exist"
fi

# Priority Score field
echo "Creating Priority Score field..."
PRIORITY_FIELD=$(gh project field-create "$PROJECT_ID" \
    --name "Priority Score" \
    --data-type "number" \
    --format json | jq -r '.id' 2>/dev/null || echo "")

if [ ! -z "$PRIORITY_FIELD" ]; then
    echo "‚úÖ Priority Score field created: $PRIORITY_FIELD"
else
    echo "‚ö†Ô∏è  Priority Score field may already exist"
fi

# Get the default status field ID
echo ""
echo "5Ô∏è‚É£ Configuring status columns..."

# Note: Status field configuration via CLI is limited
# We'll provide instructions for manual configuration
echo "‚ö†Ô∏è  Status column configuration requires manual setup via web UI"
echo "   Please follow the web UI guide for configuring:"
echo "   - üìã Backlog"
echo "   - üìÖ Sprint Planning" 
echo "   - üîÑ In Progress"
echo "   - üëÅÔ∏è Code Review"
echo "   - üß™ Testing"
echo "   - ‚úÖ Done"

# Create multiple views
echo ""
echo "6Ô∏è‚É£ Creating project views..."

# Development Flow View (default board view)
echo "Creating Development Flow view..."
DEV_VIEW=$(gh project view-create "$PROJECT_ID" \
    --name "üìä Development Flow" \
    --layout "board" \
    --format json | jq -r '.id' 2>/dev/null || echo "")

if [ ! -z "$DEV_VIEW" ]; then
    echo "‚úÖ Development Flow view created: $DEV_VIEW"
else
    echo "‚ö†Ô∏è  Development Flow view may already exist"
fi

# Sprint Planning Table View
echo "Creating Sprint Planning view..."
SPRINT_VIEW=$(gh project view-create "$PROJECT_ID" \
    --name "üìÖ Sprint Planning" \
    --layout "table" \
    --format json | jq -r '.id' 2>/dev/null || echo "")

if [ ! -z "$SPRINT_VIEW" ]; then
    echo "‚úÖ Sprint Planning view created: $SPRINT_VIEW"
else
    echo "‚ö†Ô∏è  Sprint Planning view may already exist"
fi

# Team Workload Board View
echo "Creating Team Workload view..."
TEAM_VIEW=$(gh project view-create "$PROJECT_ID" \
    --name "üë• Team Workload" \
    --layout "board" \
    --format json | jq -r '.id' 2>/dev/null || echo "")

if [ ! -z "$TEAM_VIEW" ]; then
    echo "‚úÖ Team Workload view created: $TEAM_VIEW"
else
    echo "‚ö†Ô∏è  Team Workload view may already exist"
fi

# Module Overview Board View
echo "Creating Module Overview view..."
MODULE_VIEW=$(gh project view-create "$PROJECT_ID" \
    --name "üèóÔ∏è Module Overview" \
    --layout "board" \
    --format json | jq -r '.id' 2>/dev/null || echo "")

if [ ! -z "$MODULE_VIEW" ]; then
    echo "‚úÖ Module Overview view created: $MODULE_VIEW"
else
    echo "‚ö†Ô∏è  Module Overview view may already exist"
fi

# Priority Matrix Board View  
echo "Creating Priority Matrix view..."
PRIORITY_VIEW=$(gh project view-create "$PROJECT_ID" \
    --name "üéØ Priority Matrix" \
    --layout "board" \
    --format json | jq -r '.id' 2>/dev/null || echo "")

if [ ! -z "$PRIORITY_VIEW" ]; then
    echo "‚úÖ Priority Matrix view created: $PRIORITY_VIEW"
else
    echo "‚ö†Ô∏è  Priority Matrix view may already exist"
fi

# Epic Tracking Table View
echo "Creating Epic Tracking view..."
EPIC_VIEW=$(gh project view-create "$PROJECT_ID" \
    --name "üìà Epic Progress" \
    --layout "table" \
    --format json | jq -r '.id' 2>/dev/null || echo "")

if [ ! -z "$EPIC_VIEW" ]; then
    echo "‚úÖ Epic Progress view created: $EPIC_VIEW"
else
    echo "‚ö†Ô∏è  Epic Progress view may already exist"
fi

# Add existing issues to project
echo ""
echo "7Ô∏è‚É£ Adding existing repository issues to project..."

# Get all issues from the repository
ISSUES=$(gh issue list --repo "$ORG/$REPO_NAME" --limit 50 --json number --jq '.[].number')

for issue_number in $ISSUES; do
    echo "Adding issue #$issue_number to project..."
    gh project item-add "$PROJECT_ID" --url "https://github.com/$ORG/$REPO_NAME/issues/$issue_number" 2>/dev/null || echo "‚ö†Ô∏è  Issue #$issue_number may already be in project"
done

echo "‚úÖ Issues added to project"

# Update existing epics with custom field values
echo ""
echo "8Ô∏è‚É£ Updating epic issues with field values..."

# Function to update item fields (simplified - actual implementation may vary)
update_epic_fields() {
    local issue_number=$1
    local module=$2
    local priority=$3
    local story_points=$4
    
    echo "Updating issue #$issue_number..."
    # Note: Field updates via CLI are complex and may require item IDs
    # This is a placeholder for the concept
}

# Update the three initial epics (if they exist)
echo "‚ö†Ô∏è  Epic field updates require manual configuration via web UI"
echo "   Please update the following epics with these values:"
echo "   - Multi-tenant Infrastructure Epic: Module=Infrastructure, Priority=4, Story Points=13"
echo "   - Product Catalog Epic: Module=Catalog, Priority=3, Story Points=13" 
echo "   - Channel Module Epic: Module=Channel, Priority=3, Story Points=13"

# Summary and next steps
echo ""
echo "‚úÖ ================================================"
echo "‚úÖ GitHub Project Board CLI Setup Complete!"
echo "‚úÖ ================================================"
echo ""
echo "üìã What was configured via CLI:"
echo "  ‚úì Project created/verified: $PROJECT_TITLE"
echo "  ‚úì Repository linked to project"
echo "  ‚úì Custom fields created:"
echo "    - Story Points (number)"
echo "    - Sprint (single select with 10 options)"
echo "    - Module (single select with 8 options)" 
echo "    - Priority Score (number)"
echo "  ‚úì 6 project views created:"
echo "    - üìä Development Flow (board)"
echo "    - üìÖ Sprint Planning (table)"
echo "    - üë• Team Workload (board)"
echo "    - üèóÔ∏è Module Overview (board)"
echo "    - üéØ Priority Matrix (board)"
echo "    - üìà Epic Progress (table)"
echo "  ‚úì Existing issues added to project"
echo ""
echo "‚ö†Ô∏è  Manual configuration still needed:"
echo "  1. Configure status columns in web UI:"
echo "     üìã Backlog ‚Üí üìÖ Sprint Planning ‚Üí üîÑ In Progress ‚Üí üëÅÔ∏è Code Review ‚Üí üß™ Testing ‚Üí ‚úÖ Done"
echo ""
echo "  2. Set up view grouping and filtering:"
echo "     - Module Overview: Group by Module field"
echo "     - Team Workload: Group by Assignees"
echo "     - Priority Matrix: Group by Priority Score"
echo "     - Sprint Planning: Sort by Sprint, then Priority"
echo ""
echo "  3. Configure automation workflows in project settings"
echo ""
echo "  4. Update epic issues with custom field values"
echo ""
echo "üîó Project URL: https://github.com/orgs/$ORG/projects/[project-number]"
echo ""
echo "üìñ Continue with the web UI guide for remaining configuration!"
echo ""